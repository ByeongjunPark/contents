<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://cdn.jsdelivr.net/npm/pretendard/dist/web/static/pretendard.css');
    body {
      font-family: 'Pretendard', sans-serif;
    }
    @keyframes spin-slow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-spin-slow {
      animation: spin-slow 2s linear infinite;
    }
    #resultBox table {
      width: 100% !important;
      table-layout: fixed !important;
    }
    #resultBox th, #resultBox td {
      word-wrap: break-word;
      white-space: normal;
    }
  </style>
  <script>
    function searchRegistration() {
      const phone = document.getElementById("search-phone").value.trim();
      if (!phone) {
        alert("ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ì €ì¥
      localStorage.setItem("savedPhone", phone);

      const resultBox = document.getElementById("resultBox");
      resultBox.innerHTML = "";
      document.getElementById("loadingOverlay").classList.remove("hidden");

      google.script.run
        .withSuccessHandler(renderTables)
        .getRegistrationMap('', phone);
    }

  function renderTables(data) {
  const container = document.getElementById("resultBox");
  container.innerHTML = `
    <p class="text-lg text-green-700 font-semibold mb-4">
      âœ” ì´ˆë¡ìƒ‰ ì…€ì€ ë³¸ì¸ì´ ì‹ ì²­í•œ ê°•ì˜ì…ë‹ˆë‹¤.<br>
      âœ” ì´ˆë¡ìƒ‰ ì…€ì„ í´ë¦­í•˜ë©´ ìˆ˜ê°•ì„ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>
  `;

  async function loadDaysSequentially() {
    for (let day = 1; day <= 3; day++) {
      const selected = data[`selectedDay${day}`];

      await new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(function (html) {
            const title = document.createElement("h3");
            title.textContent = `ğŸ—“ ${day}ì¼ì°¨ ê°•ì˜ ì¼ì •`;
            title.className = "text-xl font-bold mb-4 mt-8 text-green-700";
            container.appendChild(title);

            const wrapper = document.createElement("div");
            wrapper.innerHTML = html;

            wrapper.querySelectorAll("table").forEach(table => {
              table.style.width = "100%";
              table.style.tableLayout = "fixed";
            });

            const cells = wrapper.querySelectorAll("td");
            cells.forEach(td => {
              td.removeAttribute("onclick");
              td.style.cursor = "default";
              td.classList.remove("hover:bg-[#45AF76]", "hover:text-white");

              const text = td.textContent?.trim();
              if (!text) return;

              const matched = selected.some(title => text.includes(title));
              if (matched) {
                td.classList.add("bg-[#45AF76]", "text-white", "font-semibold");
                td.style.cursor = "pointer";

                td.onclick = () => {
                  console.log(`=== ì·¨ì†Œ í´ë¦­ ===`);
                  console.log(`í´ë¦­í•œ ì „ì²´ í…ìŠ¤íŠ¸: "${text}"`);
                  
                  const classTitle = text.split('ë°œí‘œì:')[0].trim();
                  console.log(`ì¶”ì¶œëœ ê°•ì˜ëª…: "${classTitle}"`);
                  console.log(`ì¼ì°¨: ${day}`);
                  
                  const confirmCancel = confirm(`"${classTitle}" ê°•ì˜ë¥¼ ì •ë§ë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                  if (!confirmCancel) return;

                  const phone = document.getElementById("search-phone").value.trim();
                  console.log(`ì „í™”ë²ˆí˜¸: "${phone}"`);
                  
                  const loadingOverlay = document.getElementById("loadingOverlay");
                  
                  // âœ… ë¡œë”© í‘œì‹œ
                  loadingOverlay.classList.remove("hidden");
                  
                  // âœ… ì•ˆì „ì¥ì¹˜: 10ì´ˆ í›„ ìë™ìœ¼ë¡œ ë¡œë”© ìˆ¨ê¹€
                  const timeoutId = setTimeout(() => {
                    loadingOverlay.classList.add("hidden");
                    alert("ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                  }, 10000);
                  
                  google.script.run
                    .withSuccessHandler((result) => {
                      // âœ… íƒ€ì„ì•„ì›ƒ í•´ì œ
                      clearTimeout(timeoutId);
                      // âœ… ë¡œë”© ìˆ¨ê¹€ - ê°€ì¥ ë¨¼ì €!
                      loadingOverlay.classList.add("hidden");
                      
                      console.log('ì·¨ì†Œ ê²°ê³¼:', result);
                      
                      if (result && result.success) {
                        alert("ìˆ˜ê°•ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        searchRegistration(); // ê°±ì‹ 
                      } else {
                        alert(`ì·¨ì†Œ ì‹¤íŒ¨: ${result?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`);
                      }
                    })
                    .withFailureHandler((error) => {
                      // âœ… íƒ€ì„ì•„ì›ƒ í•´ì œ
                      clearTimeout(timeoutId);
                      // âœ… ë¡œë”© ìˆ¨ê¹€ - ê°€ì¥ ë¨¼ì €!
                      loadingOverlay.classList.add("hidden");
                      
                      console.error('ì·¨ì†Œ ìš”ì²­ ì‹¤íŒ¨:', error);
                      alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    })
                    .cancelRegistration(classTitle, phone, day);
                };
              }
            });

            container.appendChild(wrapper);
            resolve();
          })
          .withFailureHandler((error) => {
            console.error(`Day ${day} ë¡œë”© ì‹¤íŒ¨:`, error);
            resolve(); // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë‹¤ìŒ dayë¡œ ì§„í–‰
          })
          .loadDayHtml(day);
      });
    }

    document.getElementById("loadingOverlay").classList.add("hidden");
  }

  loadDaysSequentially();
}

window.addEventListener("DOMContentLoaded", () => {
  const savedPhone = localStorage.getItem("savedPhone");
  if (savedPhone) {
    document.getElementById("search-phone").value = savedPhone;
    searchRegistration();
  }
});

</script>
</head>
<body class="bg-white p-6 text-base sm:text-lg">
  <div class="w-full px-4 sm:px-6">
    <h1 class="text-2xl sm:text-3xl font-bold text-[#45AF76] mb-6">ì‹ ì²­ ê°•ì˜ í™•ì¸</h1>

    <div class="flex flex-wrap gap-4 mb-6">
      <input
        id="search-phone"
        type="text"
        placeholder="ì—°ë½ì²˜ (ì˜ˆ: 010-1234-5678)"
        class="border border-gray-300 rounded p-4 w-full sm:w-auto flex-grow"
        maxlength="13"
        required
        oninput="
          let val = this.value.replace(/[^0-9]/g, '');
          if (val.length <= 3) {
            this.value = val;
          } else if (val.length <= 7) {
            this.value = val.slice(0, 3) + '-' + val.slice(3);
          } else {
            this.value = val.slice(0, 3) + '-' + val.slice(3, 7) + '-' + val.slice(7, 11);
          }
        "
      />
      <button onclick="searchRegistration()" class="bg-[#45AF76] text-white px-6 py-3 rounded hover:bg-[#3e9c68]">ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ</button>
    </div>

    <div id="resultBox" class="mt-6"></div>
  </div>

  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-50 hidden">
    <img src="https://raw.githubusercontent.com/ByeongjunPark/G-DEAL/master/G-DEAL_green.svg" alt="ë¡œë”©" class="h-20 animate-spin mb-4">
    <p class="text-xl font-semibold text-[#45AF76]">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
  </div>
</body>
</html>
