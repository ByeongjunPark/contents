const SHEET_NAMES = ["1ì¼ì°¨", "2ì¼ì°¨", "3ì¼ì°¨"];

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function doGet(e) {
  const page = e?.parameter?.page;

  if (page === 'day1') {
    return HtmlService.createHtmlOutputFromFile('day1')
      .setSandboxMode(HtmlService.SandboxMode.IFRAME)
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'day2') {
    return HtmlService.createHtmlOutputFromFile('day2')
      .setSandboxMode(HtmlService.SandboxMode.IFRAME) 
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'day3') {
    return HtmlService.createHtmlOutputFromFile('day3')
      .setSandboxMode(HtmlService.SandboxMode.IFRAME)
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'verify') {
    return HtmlService.createHtmlOutputFromFile('verify')
      .setSandboxMode(HtmlService.SandboxMode.IFRAME)
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }

  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setSandboxMode(HtmlService.SandboxMode.IFRAME)
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// Step 3: ìŠ¤í¬ë¦½íŠ¸ ì†ì„± ì„¤ì • í•¨ìˆ˜ (í•œ ë²ˆë§Œ ì‹¤í–‰)
function setupScriptProperties() {
  const scriptProperties = PropertiesService.getScriptProperties();
  scriptProperties.setProperties({
    'DISABLE_HEADER_TEXT': 'true',
    'CLEAN_OUTPUT': 'true'
  });
  console.log('ìŠ¤í¬ë¦½íŠ¸ ì†ì„±ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// Step 4: ì„¤ì •ì„ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
function checkSettings() {
  const scriptProperties = PropertiesService.getScriptProperties();
  console.log('í˜„ì¬ ì„¤ì •:', scriptProperties.getProperties());
  
  // ëŸ°íƒ€ì„ ë²„ì „ í™•ì¸
  console.log('ëŸ°íƒ€ì„ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
}

function troubleshootSettings() {
  try {
    // 1. í˜„ì¬ ëŸ°íƒ€ì„ í™•ì¸
    console.log('Utilities ê°ì²´ í™•ì¸:', typeof Utilities);
    
    // 2. ìŠ¤í¬ë¦½íŠ¸ ì†ì„± í™•ì¸  
    const props = PropertiesService.getScriptProperties().getProperties();
    console.log('ìŠ¤í¬ë¦½íŠ¸ ì†ì„±:', props);
    
    // 3. HTML ì„œë¹„ìŠ¤ ìƒŒë“œë°•ìŠ¤ ëª¨ë“œ í™•ì¸
    const testOutput = HtmlService.createHtmlOutput('<p>í…ŒìŠ¤íŠ¸</p>')
      .setSandboxMode(HtmlService.SandboxMode.IFRAME);
    console.log('HTML ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
    
    return "ì„¤ì • í™•ì¸ ì™„ë£Œ";
    
  } catch (error) {
    console.error('ì„¤ì • ì˜¤ë¥˜:', error);
    return "ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤: " + error.message;
  }
}

// ì„±ëŠ¥ ìµœì í™”ëœ ìˆ˜ê°•ì‹ ì²­ í•¨ìˆ˜
function submitRegistration(data) {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const daySheet = spreadsheet.getSheetByName(SHEET_NAMES[data.dayIndex]);
  const timeSheet = spreadsheet.getSheetByName('ê°•ì˜ì‹œê°„');

  const lecture = data.lecture.trim().split('\n')[0];
  const phone = data.phone.trim();
  const sheetDate = SHEET_NAMES[data.dayIndex];

  // âœ… í•œ ë²ˆì— ëª¨ë“  ë°ì´í„° ì½ê¸°
  const dayData = daySheet.getDataRange().getValues();
  const timeData = timeSheet.getDataRange().getValues();
  const headers = dayData[1]; // 2í–‰ (ì¸ë±ìŠ¤ 1)

  // 1. ê°•ì˜ì‹œê°„ ì¡°íšŒ
  let targetTime = null;
  for (let i = 1; i < timeData.length; i++) {
    const [date, place, timeRange, title] = timeData[i];
    if (
      date?.toString().trim() === sheetDate &&
      title?.toString().trim() === lecture
    ) {
      targetTime = timeRange?.toString().trim();
      break;
    }
  }

  if (!targetTime) {
    return "âŒ ê°•ì˜ ì‹œê°„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
  }

  // 2. ì‹œê°„ íŒŒì‹±
  function parseTime(str) {
    if (!str || typeof str !== 'string') return 0;
    const [h, m] = str.split(":").map(Number);
    return (h || 0) * 60 + (m || 0);
  }
  
  const timeParts = targetTime.split("~");
  if (timeParts.length !== 2) {
    return "âŒ ê°•ì˜ ì‹œê°„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  }
  
  const [targetStart, targetEnd] = timeParts.map(parseTime);

  // 3. ê²¹ì¹˜ëŠ” ê°•ì˜ ëª©ë¡ ìˆ˜ì§‘
  const overlappingLectures = new Set();
  for (let i = 1; i < timeData.length; i++) {
    const [date, , timeRange, otherLecture] = timeData[i];
    if (
      !date || !timeRange || !otherLecture ||
      date.toString().trim() !== sheetDate ||
      otherLecture.toString().trim() === lecture
    ) continue;

    const otherTimeParts = timeRange.toString().split("~");
    if (otherTimeParts.length !== 2) continue;
    
    const [start, end] = otherTimeParts.map(parseTime);
    const isOverlap = !(end <= targetStart || start >= targetEnd);

    if (isOverlap) {
      overlappingLectures.add(otherLecture.toString().trim());
    }
  }

  // 4. ë©”ëª¨ë¦¬ì—ì„œ ì¤‘ë³µ í™•ì¸ (ë§¤ìš° ë¹ ë¦„!)
  for (let col = 1; col < headers.length; col += 3) { // Bì—´ë¶€í„° ì‹œì‘
    const otherLecture = headers[col];
    if (!otherLecture || !overlappingLectures.has(otherLecture.toString().trim())) continue;

    // í•´ë‹¹ ê°•ì˜ì˜ ì—°ë½ì²˜ ì—´ì—ì„œ ì¤‘ë³µ í™•ì¸
    const phoneCol = col + 2; // ì—°ë½ì²˜ ì—´
    for (let row = 3; row < dayData.length; row++) { // 4í–‰ë¶€í„° (ì¸ë±ìŠ¤ 3)
      const savedPhone = dayData[row][phoneCol];
      if (savedPhone && savedPhone.toString().trim() === phone) {
        return `âš ï¸ ë™ì¼ ì‹œê°„ëŒ€(${targetTime})ì— ì´ë¯¸ ì‹ ì²­í•œ "${otherLecture}" ê°•ì˜ê°€ ìˆìŠµë‹ˆë‹¤.`;
      }
    }
  }

  // 5. ë™ì¼ ê°•ì˜ ì¤‘ë³µ ì‹ ì²­ í™•ì¸
  let targetCol = -1;
  for (let col = 1; col < headers.length; col += 3) {
    if (headers[col].toString().trim() === lecture) {
      targetCol = col;
      break;
    }
  }

  if (targetCol === -1) {
    return "âŒ í•´ë‹¹ ê°•ì˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + lecture;
  }

  const phoneCol = targetCol + 2;
  for (let row = 3; row < dayData.length; row++) {
    const existingPhone = dayData[row][phoneCol];
    if (existingPhone && existingPhone.toString().trim() === phone) {
      return "âš ï¸ ì´ë¯¸ ì‹ ì²­ëœ ê°•ì˜ì…ë‹ˆë‹¤. ì¤‘ë³µ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    }
  }

  // 6. ë¹ˆ ìë¦¬ ì°¾ì•„ì„œ í•œ ë²ˆì— ì €ì¥
  let targetRow = -1;
  for (let row = 3; row < dayData.length; row++) {
    if (!dayData[row][targetCol]) { // ë¹ˆ ìë¦¬ ë°œê²¬
      targetRow = row + 1; // getRangeëŠ” 1-based
      break;
    }
  }

  // ë¹ˆ ìë¦¬ê°€ ì—†ìœ¼ë©´ ìƒˆ í–‰ ì¶”ê°€
  if (targetRow === -1) {
    targetRow = dayData.length + 1;
  }

  // âœ… í•œ ë²ˆì— 3ê°œ ì…€ ì—…ë°ì´íŠ¸ (ë§¤ìš° ë¹ ë¦„!)
  const range = daySheet.getRange(targetRow, targetCol + 1, 1, 3); // +1ì€ 1-based ë³€í™˜
  range.setValues([[data.school, data.name, phone]]);

  return "âœ… ìˆ˜ê°• ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
}

// ì„±ëŠ¥ ìµœì í™”ëœ ì·¨ì†Œ í•¨ìˆ˜
function cancelRegistration(classTitle, phone, day) {
  try {
    const sheetName = `${day}ì¼ì°¨`;
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    
    if (!sheet) {
      return {
        success: false,
        message: `"${sheetName}" ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
      };
    }
    
    const data = sheet.getDataRange().getValues();
    const HEADER_ROW = 1;  // ê°•ì˜ëª…ì€ 2í–‰
    const START_ROW = 3;   // ì‹ ì²­ì ë°ì´í„°ëŠ” 4í–‰ë¶€í„°
    const BLOCK_WIDTH = 3; // ì†Œì†êµ, ì´ë¦„, ì—°ë½ì²˜ 3ì—´

    // 1. ê°•ì˜ëª…ì— í•´ë‹¹í•˜ëŠ” ì‹œì‘ì—´ ì°¾ê¸°
    let startCol = -1;
    for (let col = 1; col < data[HEADER_ROW].length; col += BLOCK_WIDTH) {
      const title = data[HEADER_ROW][col];
      if (title && title.toString().trim() === classTitle.trim()) {
        startCol = col;
        break;
      }
    }

    if (startCol === -1) {
      return {
        success: false,
        message: `"${classTitle}" ê°•ì˜ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
      };
    }

    const phoneCol = startCol + 2;

    // 2. í•´ë‹¹ ê°•ì˜ì—ì„œ ì—°ë½ì²˜ê°€ ì¼ì¹˜í•˜ëŠ” í–‰ ì°¾ê¸°
    let foundRow = -1;
    for (let row = START_ROW; row < data.length; row++) {
      const cellValue = data[row][phoneCol];
      if (cellValue && cellValue.toString().trim() === phone) {
        foundRow = row + 1; // 1-based í–‰ ë²ˆí˜¸ë¡œ ë³€í™˜
        break;
      }
    }

    if (foundRow === -1) {
      return {
        success: false,
        message: "í•´ë‹¹ ì—°ë½ì²˜ë¡œ ì‹ ì²­ëœ ìˆ˜ê°• ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
      };
    }

    // 3. âœ… í•´ë‹¹ ê°•ì˜ì˜ 3ê°œ ì…€ë§Œ ë¹„ìš°ê¸° (ë‹¤ë¥¸ ê°•ì˜ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ!)
    const targetRange = sheet.getRange(foundRow, startCol + 1, 1, BLOCK_WIDTH);
    targetRange.clearContent();

    console.log(`ì·¨ì†Œ ì™„ë£Œ: ${foundRow}í–‰, ${startCol + 1}~${startCol + 3}ì—´ ë¹„ì›€`);

    return {
      success: true,
      message: "ìˆ˜ê°•ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
    };

  } catch (error) {
    console.error('cancelRegistration ì˜¤ë¥˜:', error);
    return {
      success: false,
      message: `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`
    };
  }
}

// ğŸ” ë””ë²„ê¹…ìš© ë²„ì „ (ë¬¸ì œ í™•ì¸ìš©)
function cancelRegistrationDebug(classTitle, phone, day) {
  try {
    const sheetName = `${day}ì¼ì°¨`;
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    
    console.log('=== ì·¨ì†Œ ì‹œì‘ ===');
    console.log('ê°•ì˜ëª…:', classTitle);
    console.log('ì—°ë½ì²˜:', phone);
    console.log('ì¼ì°¨:', day);
    
    const data = sheet.getDataRange().getValues();
    const HEADER_ROW = 1;
    const START_ROW = 3;
    const BLOCK_WIDTH = 3;

    // í—¤ë” ì¶œë ¥ (ë””ë²„ê¹…ìš©)
    console.log('í—¤ë” í™•ì¸:', data[HEADER_ROW]);

    // ê°•ì˜ ìœ„ì¹˜ ì°¾ê¸°
    let startCol = -1;
    for (let col = 1; col < data[HEADER_ROW].length; col += BLOCK_WIDTH) {
      const title = data[HEADER_ROW][col];
      console.log(`col ${col}: "${title}"`);
      if (title && title.toString().trim() === classTitle.trim()) {
        startCol = col;
        console.log('ê°•ì˜ ì°¾ìŒ! startCol:', startCol);
        break;
      }
    }

    if (startCol === -1) {
      console.log('ê°•ì˜ë¥¼ ì°¾ì§€ ëª»í•¨');
      return { success: false, message: "ê°•ì˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
    }

    // ì—°ë½ì²˜ ì°¾ê¸°
    const phoneCol = startCol + 2;
    console.log('ì—°ë½ì²˜ ì—´:', phoneCol);
    
    let foundRow = -1;
    for (let row = START_ROW; row < data.length; row++) {
      const cellValue = data[row][phoneCol];
      console.log(`${row + 1}í–‰ ì—°ë½ì²˜: "${cellValue}"`);
      if (cellValue && cellValue.toString().trim() === phone) {
        foundRow = row + 1; // 1-based
        console.log('ì—°ë½ì²˜ ì°¾ìŒ! foundRow:', foundRow);
        break;
      }
    }

    if (foundRow === -1) {
      console.log('ì—°ë½ì²˜ë¥¼ ì°¾ì§€ ëª»í•¨');
      return { success: false, message: "ì—°ë½ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
    }

    // ì‚­ì œ ì „ í•´ë‹¹ í–‰ ë°ì´í„° í™•ì¸
    console.log('ì‚­ì œ ì „ í•´ë‹¹ í–‰ ì „ì²´ ë°ì´í„°:', data[foundRow - 1]);

    // âœ… ì •í™•íˆ 3ê°œ ì…€ë§Œ ë¹„ìš°ê¸°
    console.log(`ë¹„ìš¸ ë²”ìœ„: ${foundRow}í–‰, ${startCol + 1}~${startCol + 3}ì—´`);
    
    const targetRange = sheet.getRange(foundRow, startCol + 1, 1, BLOCK_WIDTH);
    targetRange.clearContent();

    console.log('=== ì·¨ì†Œ ì™„ë£Œ ===');

    return { success: true, message: "ìˆ˜ê°•ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤." };

  } catch (error) {
    console.error('ì˜¤ë¥˜:', error);
    return { success: false, message: `ì˜¤ë¥˜: ${error.message}` };
  }
}

// ì„±ëŠ¥ ìµœì í™”ëœ ì¡°íšŒ í•¨ìˆ˜
function getRegistrationMap(name, phone) {
  const result = {};
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();

  for (let day = 0; day < SHEET_NAMES.length; day++) {
    const sheet = spreadsheet.getSheetByName(SHEET_NAMES[day]);
    // âœ… í•œ ë²ˆì— ëª¨ë“  ë°ì´í„° ì½ê¸°
    const data = sheet.getDataRange().getValues();
    const headerRow = data[1]; // 2í–‰

    const lectures = [];
    const selectedLectures = [];

    for (let col = 1; col < headerRow.length; col += 3) {
      const lectureTitle = headerRow[col];
      if (!lectureTitle) continue;

      lectures.push(lectureTitle);

      // ë©”ëª¨ë¦¬ì—ì„œ ê²€ìƒ‰ (ë§¤ìš° ë¹ ë¦„!)
      const phoneCol = col + 2;
      for (let row = 3; row < data.length; row++) { // 4í–‰ë¶€í„°
        const storedPhone = data[row][phoneCol];
        if (storedPhone && storedPhone.toString().trim() === phone) {
          selectedLectures.push(lectureTitle);
          break;
        }
      }
    }

    result[`day${day + 1}`] = lectures;
    result[`selectedDay${day + 1}`] = selectedLectures;
  }

  return result;
}

function loadDayHtml(dayIndex) {
  return HtmlService.createHtmlOutputFromFile(`day${dayIndex}`).getContent();
}

